<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Continuous Delivery with Jenkins workflow and Docker - Coding Stories</title>

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Continuous Delivery with Jenkins workflow and Docker">
    <meta name="twitter:description" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Continuous Delivery with Jenkins workflow and Docker">
    <meta property="og:description" content="">

    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="/apple-touch-icon-precomposed.png" rel="apple-touch-icon">

    <link rel="stylesheet" type="text/css" href="//jcsirot.github.io/hubpress.io/themes/uno/assets/css/uno.css?v=1468853184663" />

    <link rel="canonical" href="https://jcsirot.github.io/hubpress.io/2015/08/23/Continuous-Delivery-with-Jenkins-workflow-and-Docker.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="Coding Stories" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Continuous Delivery with Jenkins workflow and Docker" />
    <meta property="og:description" content="Recently Cloudbees releases the CloudBees Docker Workflow Plugin to make the integration of Docker with Jenkins workflows as easy as possible. Now, deploying a continuous delivery pipeline is (almost) straightforward. Here is a simple but comprehensive example. Disclaimer: I&amp;#8217;m using a maven project for this example because maven" />
    <meta property="og:url" content="https://jcsirot.github.io/hubpress.io/2015/08/23/Continuous-Delivery-with-Jenkins-workflow-and-Docker.html" />
    <meta property="article:tag" content="Continuous Delivery" />
    <meta property="article:tag" content=" Jenkins" />
    <meta property="article:tag" content=" Jenkins workflow" />
    <meta property="article:tag" content=" maven" />
    <meta property="article:tag" content=" Docker" />
    <meta property="article:tag" content=" devops" />
    <meta property="article:tag" content=" test" />
    <meta property="article:tag" content=" en" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Continuous Delivery with Jenkins workflow and Docker" />
    <meta name="twitter:description" content="Recently Cloudbees releases the CloudBees Docker Workflow Plugin to make the integration of Docker with Jenkins workflows as easy as possible. Now, deploying a continuous delivery pipeline is (almost) straightforward. Here is a simple but comprehensive example. Disclaimer: I&amp;#8217;m using a maven project for this example because maven" />
    <meta name="twitter:url" content="https://jcsirot.github.io/hubpress.io/2015/08/23/Continuous-Delivery-with-Jenkins-workflow-and-Docker.html" />
    
    <script type="application/ld+json">
null
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="Coding Stories" href="https://jcsirot.github.io/hubpress.io/rss/" />

</head>
<body class="post-template tag-Continuous-Delivery tag-Jenkins tag-Jenkins-workflow tag-maven tag-Docker tag-devops tag-test tag-en no-js">

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    <header class="panel-cover panel-cover--collapsed " style="background-image: url(images/cover/cover.jpg)">
      <div class="panel-main">
    
        <div class="panel-main__inner panel-inverted">
        <div class="panel-main__content">
    
            <h1 class="panel-cover__title panel-title"><a href="https://jcsirot.github.io/hubpress.io" title="link to homepage for Coding Stories">Coding Stories</a></h1>
            <hr class="panel-cover__divider" />
            <p class="panel-cover__description">Singe savant en ing√©nierie logicielle</p>
            <hr class="panel-cover__divider panel-cover__divider--secondary" />
    
            <div class="navigation-wrapper">
    
              <nav class="cover-navigation cover-navigation--primary">
                <ul class="navigation">
                  <li class="navigation__item"><a href="https://jcsirot.github.io/hubpress.io/#blog" title="link to Coding Stories blog" class="blog-button">Blog</a></li>
                </ul>
              </nav>
    
              
              
              <nav class="cover-navigation navigation--social">
                <ul class="navigation">
              
              
                  <!-- Twitter -->
                  <li class="navigation__item">
                    <a href="jcsirot" title="Twitter account">
                      <i class='icon icon-social-twitter'></i>
                      <span class="label">Twitter</span>
                    </a>
                  </li>
              
              
              
              
              
              
              
              
                </ul>
              </nav>
              
    
            </div>
    
          </div>
    
        </div>
    
        <div class="panel-cover--overlay"></div>
      </div>
    </header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            

  <article class="post-container post-container--single">

    <header class="post-header">
      <div class="post-meta">
        <time datetime="23 Aug 2015" class="post-meta__date date">23 Aug 2015</time> &#8226; <span class="post-meta__tags tags">on <a href="https://jcsirot.github.io/hubpress.io/tag/Continuous-Delivery/">Continuous Delivery</a>, <a href="https://jcsirot.github.io/hubpress.io/tag/Jenkins/"> Jenkins</a>, <a href="https://jcsirot.github.io/hubpress.io/tag/Jenkins-workflow/"> Jenkins workflow</a>, <a href="https://jcsirot.github.io/hubpress.io/tag/maven/"> maven</a>, <a href="https://jcsirot.github.io/hubpress.io/tag/Docker/"> Docker</a>, <a href="https://jcsirot.github.io/hubpress.io/tag/devops/"> devops</a>, <a href="https://jcsirot.github.io/hubpress.io/tag/test/"> test</a>, <a href="https://jcsirot.github.io/hubpress.io/tag/en/"> en</a></span>
        <span class="post-meta__author author"><img src="https://avatars.githubusercontent.com/u/470082?v&#x3D;3" alt="profile image for Jean-Christophe Sirot" class="avatar post-meta__avatar" /> by Jean-Christophe Sirot</span>
      </div>
      <h1 class="post-title">Continuous Delivery with Jenkins workflow and Docker</h1>
    </header>

    <section class="post tag-Continuous-Delivery tag-Jenkins tag-Jenkins-workflow tag-maven tag-Docker tag-devops tag-test tag-en">
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Recently Cloudbees releases the <a href="https://wiki.jenkins-ci.org/display/JENKINS/CloudBees+Docker+Workflow+Plugin">CloudBees Docker Workflow Plugin</a> to make the integration of Docker with Jenkins workflows as easy as possible. Now, deploying a continuous delivery pipeline is (almost) straightforward. Here is a simple but comprehensive example.</p>
</div>
<div class="paragraph">
<p><em>Disclaimer</em>: I&#8217;m using a maven project for this example because maven is a tool I&#8217;m comfortable with. This post could be adapted to python, rails or whatever-you-want project with minor efforts.</p>
</div>
<div class="paragraph">
<p>First of all, we need to install the required plugins in Jenkins:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Workflow: Aggregator</p>
</li>
<li>
<p>CloudBees Docker Workflow</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This sample workflow is simple and composed of 4 steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Build and unit tests</p>
</li>
<li>
<p>Build Docker image</p>
</li>
<li>
<p>Acceptance Tests</p>
</li>
<li>
<p>Push Docker image</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_and_unit_tests">Build and unit tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In a new Workflow job enter this script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">node {
    /* Configure the JDK to use. 'JDK8' is the symbolic name under which the JDK
     * is defined in the global Jenkins configuration. */
    env.JAVA_HOME="${tool 'JDK8'}"

    stage 'Build'
    /* Clone the project from github */
    git url: 'https://github.com/jcsirot/atmosphere-calculator.git', branch: '0.1.0'
    /* Select the maven configuration. 'M3' is the symbolic name used the
     * global Jenkins configuration. */
    def mvnHome = tool "M3"
    /* Run maven: build and run the unit tests  */
    sh "${mvnHome}/bin/mvn clean package"
    /* This is the syntax for using a generic step. Here the test results are archived. */
    step([$class: 'JUnitResultArchiver', testResults: '**/target/surefire-reports/TEST-*.xml'])
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This short script runs maven to build the jars and to execute the unit tests. Now we are ready to build the Docker image.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_docker_image">Build Docker image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The CloudBees Docker Workflow Plugin provides a global variable <code>docker</code> which offers access to the common Docker functions in workflow scripts. For a comprehensive description of the plugin and the available commands, look at the <a href="http://documentation.cloudbees.com/docs/cje-user-guide/docker-workflow.html">plugin guide</a>.</p>
</div>
<div class="paragraph">
<p>To build the image we call <code>build</code> on the <code>docker</code> variable. Two parameters are passed: the image name (with the Docker notation <code>[registry/]image[:tag]</code>) and the directory where is located the <code>Dockerfile</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">node {
    /* ... */
    stage 'Build Docker image'
    def image = docker.build('jcsirot/atmo-calc:snapshot', '.')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The call returns a handle on the built image so we can work with it.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_acceptance_tests">Acceptance Tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to execute the acceptance tests we wants to run a container from our newly built image. The <code>withRun</code> method can be invoked on the image handle. It is possible to pass the <code>docker run</code> parameters like port mapping or volumes configuration.</p>
</div>
<div class="paragraph">
<p><code>withRun</code> also takes a code block. The container is started at the begining of the block, then the code in the block is executed and the container is stopped at the end of the block. Note that the block is executed on the Jenkins node, <em>not inside the container</em>. Use the <code>inside</code> method on the image handle to execute code inside the container.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">node {
    /* ... */
    stage 'Acceptance Tests'
    image.withRun('-p 8181:8181') {c -&gt;
        sh "${mvnHome}/bin/mvn verify"
    }
    /* Archive acceptance tests results */
    step([$class: 'JUnitResultArchiver', testResults: '**/target/failsafe-reports/TEST-*.xml'])
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_push_docker_image">Push Docker image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The last step consists in pushing the image to a Docker registry. It can be done with the method <code>push</code>.</p>
</div>
<div class="paragraph">
<p>In order to configure the registry credentials, go the Jenkins Manager Credentials page. Add a new username/password entry and enter your registry login and password. Click on <em>Advanced</em> to show the ID field and enter a unique identifier.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://jcsirot.github.io/hubpress.io/images/posts/jenkins-docker-credentials-20150823.png" alt="Docker Hub Credentials">
</div>
</div>
<div class="paragraph">
<p>The <code>withRegistry</code> method is also used to pass the registry URL and credentials ID configure above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">node {
    /* ... */
    stage 'Push image'
    docker.withRegistry("https://registry.hub.docker.com", "docker-registry") {
        image.push()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The image is pushed and, unless you pushed it to a custom registry, should be available on the <a href="https://hub.docker.com/">Docker hub</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_s_next">What&#8217;s next?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This example is simple and far from being perfect. Feel free to share suggestions or questions in the comments.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The project I used for this sample: <a href="https://github.com/jcsirot/atmosphere-calculator">https://github.com/jcsirot/atmosphere-calculator</a></p>
</li>
<li>
<p>The workflow script: <a href="https://gist.github.com/jcsirot/4de001d280998f27aa82">https://gist.github.com/jcsirot/4de001d280998f27aa82</a></p>
</li>
</ul>
</div>
</div>
</div>
    </section>

  </article>




            <footer class="footer">
                <span class="footer__copyright">&copy; 2016. All rights reserved.</span>
                <span class="footer__copyright"><a href="http://uno.daleanthony.com" title="link to page for Uno Ghost theme">Uno theme</a> by <a href="http://daleanthony.com" title="link to website for Dale-Anthony">Dale-Anthony</a></span>
                <span class="footer__copyright">Proudly published with <a href="http://hubpress.io" title="link to Hubpress website">Hubpress</a></span>
            </footer>
        </div>
    </div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();
      </script>

    <script type="text/javascript" src="//jcsirot.github.io/hubpress.io/themes/uno/assets/js/main.js?v=1468853184663"></script>
    

</body>
</html>
